<?php
/*
Malware code Scanner - 
This code will scan all php files on a given directory and all of its sub directories for
instances of the eval(base64_decode php inserted code.
ver: 1.0.1 

settings:
	you should set the absolute path of the base directory that you want to scan.
 	also change the email address settings with you own email address so that you could be notified through email
    you may run this code manually but setting up a cron job to have run this code periodically is suggested.
 
Norbert Christian L. Feria
http://www.ombing.com
*/

class malScanner{
	
	var $mtstart;
	var $mtend;
	var $exectime;
	var $dater;
	var $timer;
	
	var $basedir;
	var $directories = array();
	var $files_found = array();
	var $no_files_scanned;
	var $no_files_cleaned;
	var $patterns;
	
	var $webmaster_email = "your@email.com";
	var $website_name = "yourwebsite.com";
	
	#patterns based on the code from
	#http://www.php-beginners.com/solve-wordpress-malware-script-attack-fix.html#id-download
	var $malPatterns = array(
"^<\?php\s*\\\$md5\s*=\s*.*create_function\s*\(.*?\);\s*\\\$.*?\)\s*;\s*\?>\s*",
" echo \"<script type=\\\\\"text\/javascript\\\\\" src=\\\\\"http:\/\/.*\.js\\\\\"><\/script>\"; echo \"\";",
"<\?php\s*\@error_reporting\(0\);\s*if\s*\(\!isset\(([\$\w]+)\)\)\s*{[\$]+[^}]+}\s*\?>",
"<\?php\s*\/\*\w+_on\*\/.*\/\*\w+_off\*\/\s*\?>",
"<\?php\s*\/\*god_mode_on\*\/eval\(base64_decode\([\"'][^\"']{255,}[\"']\)\);\s*\/\*god_mode_off\*\/\s*\?>",
"<\?php\s*\?>",
"<IfModule\s*mod_rewrite\.c>\s*RewriteEngine\s*On\s*RewriteCond\s*%\{HTTP_REFERER\}\s*\^\.\*\([^\)]{255,}[google|yahoo|bing|ask|wikipedia|youtube][^\)]{255,}[^<]*<\/IfModule>",
"ErrorDocument\s*(?:400|401|403|404|500)+\s*http:\/\/.*\.\w+",
"^<script>(.*)<\/script>",
"^<\?php\s*\\\$md5\s*=\s*[\"|']\w+[\"|'];\s*\\\$wp_salt\s*=\s*[\w\(\),\"\'\;\$]+\s*\\\$wp_add_filter\s*=\s*create_function\(.*\);\s*\\\$wp_add_filter\(.*\);\s*\?>\s*",
"\s*eval\(base64_decode\([\"'][^\"']{255,}[\"']\)\);",
"if\(!function_exists\([^{]+\s*{\s*function[^}]+\s*}\s*[^\"']+\s*[\"'][^\"']+[\"'];\s*eval\s*\(.*\)\s*;\s*}\s*",
);
	var $filetypes = array("php", "shtml", "html", "htm", "js", "css", "txt");

	function __construct($basedir,$displayOnly = TRUE ,$wname = "" ,$wemail = "") {
		
		$this->mtstart = $this->microtime_float();
		$this->website_name = $wname;
		$this->webmaster_email = $wemail;
		$this->no_files_scanned = 0;
		$this->no_files_cleaned = 0;
		$this->dater = date('d-m-Y');
		$this->timer = date('H:i:n:s');
		$this->basedir = $basedir;
		
		$this->patterns = '('.implode('|', $this->malPatterns).')';
		
		$this->directories[] = $basedir;
		$directories = $this->get_Directories($this->basedir);
		$this->get_subs($directories);
		$this->startscan();
		$this->exectime = $this->getexectime();
		
		if($displayOnly == TRUE){
			$this->DisplayNotice();
		}else{
			$this->sendReport();
		}#if displayonly
		
	}#construct function
		
	function startscan(){
		foreach($this->directories as $directory) {
			foreach($this->filetypes as $filetype){
				$files = glob($directory . '/*.'.$filetype , GLOB_NOSORT);		
				$this->scanner($files);
			}#for each filetype
			$files = glob($directory . '/.htaccess' , GLOB_NOSORT);		
			$this->scanner($files);
		}#for each directory
	}#function scan
	
	function scanner($files){
		if(is_array($files)) {
	      	foreach($files as $file) {
	       			$this->no_files_scanned++;
					$file_contents = file_get_contents($file);
					$numMatches = null;
					$numMatches = preg_match_all('/'.$this->patterns.'/is', $file_contents,$matches);
					if(!empty($numMatches)){
						$this->files_found[] = $file;
						$this->cleanInfected($file);
					}#if found !empty
			}#foreach
		}#if isarray
	}#function scanner
	
	function cleanInfected($file){
		$handle = fopen($file, "r");
		if(filesize($file) > 0){
			$contents = fread($handle, filesize($file));
			fclose($handle);
			$handle = fopen($file, "w");
			$contents = preg_replace('/'.$this->patterns.'/is', "", $contents);	
			fwrite($handle, $contents);
			$this->no_files_cleaned++;
		}
		fclose($handle);
	}
	
	function get_Directories($basedir){
		$directories = glob($basedir . '/*' , GLOB_ONLYDIR);
		return $directories;
	}#get_Directories
	
	function get_subs($directories){
		foreach($directories as $directory){
			#echo $directory."<BR>";
			$this->directories[] = $directory; 
			$subs = $this->get_Directories($directory);
			$this->get_subs($subs);
		}#foreach
	}#function get_subs
	
	function microtime_float() {
    	list($usec, $sec) = explode(" ", microtime());
    	return ((float)$usec + (float)$sec);
	}
	
	
	function getexectime(){
		$this->mtend = $this->microtime_float();
		return round($this->mtend - $this->mtstart, 4);
	}#getexectime
  	
  	function scan_summary_report(){
  		$num_infected_files = count($this->files_found);
  		$sdstr = $this->website_name.'
  		maintenance Report - Malware code scanner ver 1.0 (10-2)<BR><BR>
  		Date of Execution : '.$this->dater.'<BR>
		time of Exectuion : '.$this->timer.'<BR>
		Start time stamp : '.$this->mtstart.'<BR>
		End time stamp : '.$this->mtend.'<BR>
  		Total Execution time : '.$this->exectime.'<BR>
  		<BR>
  		Website : '.$this->website_name.'<BR>
  		Base Directory : '.$this->basedir.'<BR>
  		Total Directories scanned : '.count($this->directories).'<BR>
		Total files scanned : '.$this->no_files_scanned.'<BR>
		Total files with Malware inserted code : '.$num_infected_files.'<BR>
		Total files with Malware inserted code Cleaned : '.$this->no_files_cleaned.'<BR>
		<BR>
  		';
		if($num_infected_files > 0){
			$sdstr .= '*NOTE: Change all access codes: FTP passwords, website admin passwords, Authentication salts<BR><BR>';
			$sdstr .= 'Files infected:<BR>';
			foreach($this->files_found as $file){
				$sdstr .= $file.'<BR>';			
			}#foreach
		}#if $numinfected files > 0
		return $sdstr;
  	}#scan summary report
  	
  	function DisplayNotice(){
  		$Notice = "";
  		$num_infected_files = count($this->files_found);
		if($num_infected_files > 0){
			$Notice .= "MALICIOUS CODE FOUND - ".$this->website_name;
		}else{
			$Notice .= "Scan results - ".$this->website_name;
		}
		$Notice .= "<BR>".$this->scan_summary_report();
		echo $Notice;
  	}#DisplayNotice
  	
  	function sendReport(){
        $to  = $this->webmaster_email;
		$num_infected_files = count($this->files_found);
		if($num_infected_files > 0){
			$subject = "MALICIOUS CODE FOUND - ".$this->website_name;
		}else{
			$subject = "Scan results - ".$this->website_name;
		}
		$message = $this->scan_summary_report();
		
		$headers  = 'MIME-Version: 1.0' . "\r\n";
        $headers .= 'Content-type: text/html; charset=iso-8859-1' . "\r\n";
        $headers .= 'To: '.$this->website_name.' Webmaster <'.$this->webmaster_email.'>' . "\r\n";
        $headers .= 'From: '.$this->website_name.' <'.$this->webmaster_email.'>' . "\r\n";
		     
	    mail($to, $subject, $message, $headers);
    }#function mail
  	
}#class malScanner



?>